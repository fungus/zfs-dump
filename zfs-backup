#!/bin/bash
set -o pipefail
DEST=/cifs/lonnie.olson/backups

level=0
[ "$#" -gt 0 ] && level=$1

BACKUP="tank/backup tank/home tank/vmware/Windows10"

for fs in $BACKUP
do
    for i in `seq 9 -1 $level`
    do
        d=$DEST/${fs//\//_}.$i.gz
        [ -f $d ] && mv $d $d.bak
    done

    zfs-dump -$level $fs | gzip > $d
    [ $? -ne 0 ] && exit 1
done

find $DEST -name \*.bak -delete

